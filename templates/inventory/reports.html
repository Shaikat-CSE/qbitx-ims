{% extends 'base.html' %}
{% load inventory_extras %}

{% block title %}Reports - QBITX IMS Transform Suppliers{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Reports</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'reports' %}?type=inventory" class="btn btn-sm btn-outline-secondary {% if report_type == 'inventory' %}active{% endif %}">
                <i class="fas fa-boxes"></i> Inventory
            </a>
            <a href="{% url 'reports' %}?type=sales" class="btn btn-sm btn-outline-secondary {% if report_type == 'sales' %}active{% endif %}">
                <i class="fas fa-shopping-cart"></i> Sales
            </a>
            <a href="{% url 'reports' %}?type=purchase" class="btn btn-sm btn-outline-secondary {% if report_type == 'purchase' %}active{% endif %}">
                <i class="fas fa-truck-loading"></i> Purchase
            </a>
            <a href="{% url 'reports' %}?type=wastage" class="btn btn-sm btn-outline-secondary {% if report_type == 'wastage' %}active{% endif %}">
                <i class="fas fa-trash-alt"></i> Wastage
            </a>
            <a href="{% url 'reports' %}?type=payment" class="btn btn-sm btn-outline-secondary {% if report_type == 'payment' %}active{% endif %}">
                <i class="fas fa-money-bill-wave"></i> Payments
            </a>
        </div>
    </div>
</div>

<!-- Advanced Filtering Options -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
            <i class="fas fa-filter"></i> Advanced Filters
        </button>
    </div>
    <div class="collapse" id="filterCollapse" data-show-filters="{% if applied_filters %}true{% else %}false{% endif %}">
        <div class="card-body">
            <form method="get" action="{% url 'reports' %}" class="row g-3">
                <input type="hidden" name="type" value="{{ report_type }}">
                
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">From</span>
                        <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">To</span>
                        <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Product</label>
                    <select name="product_id" class="form-select form-select-sm">
                        <option value="">All Products</option>
                        {% for product in all_products %}
                        <option value="{{ product.id }}" {% if product_id == product.id %}selected{% endif %}>{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Category</label>
                    <select name="category_id" class="form-select form-select-sm">
                        <option value="">All Categories</option>
                        {% for category in all_categories %}
                        <option value="{{ category.id }}" {% if category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Supplier</label>
                    <select name="supplier_id" class="form-select form-select-sm">
                        <option value="">All Suppliers</option>
                        {% for supplier in all_suppliers %}
                        <option value="{{ supplier.id }}" {% if supplier_id == supplier.id %}selected{% endif %}>{{ supplier.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Client</label>
                    <select name="client_id" class="form-select form-select-sm">
                        <option value="">All Clients</option>
                        {% for client in all_clients %}
                        <option value="{{ client.id }}" {% if client_id == client.id %}selected{% endif %}>{{ client.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Group By</label>
                    <select name="group_by" class="form-select form-select-sm">
                        <option value="" {% if not group_by %}selected{% endif %}>No Grouping</option>
                        <option value="product" {% if group_by == 'product' %}selected{% endif %}>Product</option>
                        <option value="category" {% if group_by == 'category' %}selected{% endif %}>Category</option>
                        <option value="supplier" {% if group_by == 'supplier' %}selected{% endif %}>Supplier</option>
                        <option value="client" {% if group_by == 'client' %}selected{% endif %}>Client</option>
                        <option value="date" {% if group_by == 'date' %}selected{% endif %}>Date</option>
                        {% if report_type == 'payment' %}
                        <option value="payment_status" {% if group_by == 'payment_status' %}selected{% endif %}>Payment Status</option>
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Sort By</label>
                    <select name="sort_by" class="form-select form-select-sm">
                        <option value="date_desc" {% if sort_by == 'date_desc' %}selected{% endif %}>Date (Newest First)</option>
                        <option value="date_asc" {% if sort_by == 'date_asc' %}selected{% endif %}>Date (Oldest First)</option>
                        <option value="quantity_desc" {% if sort_by == 'quantity_desc' %}selected{% endif %}>Quantity (High to Low)</option>
                        <option value="quantity_asc" {% if sort_by == 'quantity_asc' %}selected{% endif %}>Quantity (Low to High)</option>
                        <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Price (High to Low)</option>
                        <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Price (Low to High)</option>
                    </select>
                </div>
                {% if report_type == 'payment' %}
                <div class="col-md-3">
                    <label class="form-label">Payment Status</label>
                    <select name="payment_status" class="form-select form-select-sm">
                        <option value="">All Statuses</option>
                        <option value="paid" {% if payment_status == 'paid' %}selected{% endif %}>Paid</option>
                        <option value="due" {% if payment_status == 'due' %}selected{% endif %}>Due</option>
                        <option value="partial" {% if payment_status == 'partial' %}selected{% endif %}>Partially Paid</option>
                        <option value="credit" {% if payment_status == 'credit' %}selected{% endif %}>Credit</option>
                    </select>
                </div>
                {% endif %}
                <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-sm">Apply Filters</button>
                    <a href="{% url 'reports' %}?type={{ report_type }}" class="btn btn-outline-secondary btn-sm">Reset Filters</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add a direct link for PDF download -->
<div class="d-flex justify-content-between mb-3">
    <h5>{{ report_title }}</h5>
    <div>
        <a href="{% url 'generate_report_pdf' report_type %}?{% if start_date %}start_date={{ start_date|date:'Y-m-d' }}&{% endif %}{% if end_date %}end_date={{ end_date|date:'Y-m-d' }}&{% endif %}{% if product_id %}product_id={{ product_id }}&{% endif %}{% if category_id %}category_id={{ category_id }}&{% endif %}{% if supplier_id %}supplier_id={{ supplier_id }}&{% endif %}{% if client_id %}client_id={{ client_id }}&{% endif %}{% if group_by %}group_by={{ group_by }}&{% endif %}{% if sort_by %}sort_by={{ sort_by }}&{% endif %}" class="btn btn-sm btn-outline-success">
            <i class="fas fa-file-pdf"></i> Direct PDF Download
        </a>
        <button class="btn btn-sm btn-outline-primary download-pdf-btn" data-report-type="{{ report_type }}">
            <i class="fas fa-file-pdf"></i> Customize PDF
        </button>
    </div>
</div>

{% if report_type == 'inventory' %}
<!-- Inventory Value Report -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Inventory Value Report</h5>
        <small class="text-muted">As of {{ today|date:"F j, Y" }}</small>
        {% if applied_filters %}
        <div class="mt-2">
            <span class="badge bg-info">Applied Filters: {{ applied_filters }}</span>
        </div>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>SKU</th>
                        <th>Category</th>
                        <th>Supplier</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ product.name }}</td>
                        <td>{{ product.sku }}</td>
                        <td>{{ product.category.name }}</td>
                        <td>{% if product.supplier %}{{ product.supplier.name }}{% else %}-{% endif %}</td>
                        <td>{{ product.quantity }}</td>
                        <td>{{ product.buying_price }}</td>
                        <td>{{ product.total_value|floatformat:2 }}</td>
                        <td>
                            {% if product.is_low_stock %}
                            <span class="badge bg-danger">Low Stock</span>
                            {% else %}
                            <span class="badge bg-success">In Stock</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">No products available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-dark">
                        <td colspan="4" class="text-end"><strong>Total Quantity:</strong></td>
                        <td><strong>{{ total_quantity }}</strong></td>
                        <td class="text-end"><strong>Total Value:</strong></td>
                        <td><strong>{{ total_value|floatformat:2 }}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

{% elif report_type == 'sales' %}
<!-- Sales Report -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">Sales Report</h5>
                <small class="text-muted">{{ start_date|date:"F j, Y" }} to {{ end_date|date:"F j, Y" }}</small>
                {% if applied_filters %}
                <div class="mt-2">
                    <span class="badge bg-info">Applied Filters: {{ applied_filters }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if group_by %}
        <div class="alert alert-info">
            <strong>Grouped by: {{ group_by_display }}</strong>
        </div>
        {% endif %}
        
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>UOM</th>
                        <th>Buying Price</th>
                        <th>Selling Price</th>
                        <th>VAT (%)</th>
                        <th>AIT (%)</th>
                        <th>Final Price</th>
                        <th>Total Price</th>
                        <th>Profit/Loss</th>
                        <th>Client</th>
                        <th>Payment Status</th>
                        <th>Reference</th>
                    </tr>
                </thead>
                <tbody>
                    {% if grouped_data %}
                        {% for group in grouped_data %}
                        <tr class="table-secondary">
                            <td colspan="15"><strong>{{ group.name }}</strong></td>
                        </tr>
                        {% for sale in group.transactions %}
                        <tr>
                            <td>{{ sale.id }}</td>
                            <td>{{ sale.transaction_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ sale.product.name }}</td>
                            <td>{{ sale.quantity }}</td>
                            <td>{{ sale.product.unit_of_measure }}</td>
                            <td>{{ sale.buying_price }}</td>
                            <td>{{ sale.selling_price }}</td>
                            <td>
                                {% if not sale.apply_taxes %}
                                -
                                {% else %}
                                {{ sale.vat_rate|default:"0" }}
                                {% endif %}
                            </td>
                            <td>
                                {% if not sale.apply_taxes %}
                                -
                                {% else %}
                                {{ sale.ait_rate|default:"0" }}
                                {% endif %}
                            </td>
                            <td>{% if sale.apply_taxes and sale.final_price %}{{ sale.final_price }}{% else %}{{ sale.selling_price }}{% endif %}</td>
                            <td>{{ sale.total_price }}</td>
                            <td>{{ sale.profit_loss }}</td>
                            <td>{% if sale.client %}{{ sale.client.name }}{% else %}-{% endif %}</td>
                            <td>
                                {% if sale.payment_status == 'paid' %}
                                <span class="badge bg-success">Paid</span>
                                {% elif sale.payment_status == 'due' %}
                                <span class="badge bg-danger">Due</span>
                                {% elif sale.payment_status == 'partial' %}
                                <span class="badge bg-warning">Partially Paid</span>
                                {% elif sale.payment_status == 'credit' %}
                                <span class="badge bg-info">Credit</span>
                                {% else %}
                                <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ sale.reference_number|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-light">
                            <td colspan="10" class="text-end"><em>Subtotal:</em></td>
                            <td><em>{{ group.subtotal|floatformat:2 }}</em></td>
                            <td colspan="4"></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        {% for sale in sales %}
                        <tr>
                            <td>{{ sale.id }}</td>
                            <td>{{ sale.transaction_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ sale.product.name }}</td>
                            <td>{{ sale.quantity }}</td>
                            <td>{{ sale.product.unit_of_measure }}</td>
                            <td>{{ sale.buying_price }}</td>
                            <td>{{ sale.selling_price }}</td>
                            <td>
                                {% if not sale.apply_taxes %}
                                -
                                {% else %}
                                {{ sale.vat_rate|default:"0" }}
                                {% endif %}
                            </td>
                            <td>
                                {% if not sale.apply_taxes %}
                                -
                                {% else %}
                                {{ sale.ait_rate|default:"0" }}
                                {% endif %}
                            </td>
                            <td>{% if sale.apply_taxes and sale.final_price %}{{ sale.final_price }}{% else %}{{ sale.selling_price }}{% endif %}</td>
                            <td>{{ sale.total_price }}</td>
                            <td>{{ sale.profit_loss }}</td>
                            <td>{% if sale.client %}{{ sale.client.name }}{% else %}-{% endif %}</td>
                            <td>
                                {% if sale.payment_status == 'paid' %}
                                <span class="badge bg-success">Paid</span>
                                {% elif sale.payment_status == 'due' %}
                                <span class="badge bg-danger">Due</span>
                                {% elif sale.payment_status == 'partial' %}
                                <span class="badge bg-warning">Partially Paid</span>
                                {% elif sale.payment_status == 'credit' %}
                                <span class="badge bg-info">Credit</span>
                                {% else %}
                                <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ sale.reference_number|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="15" class="text-center">No sales data available for the selected period.</td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
                <tfoot>
                    <tr class="table-dark">
                        <td colspan="3" class="text-end"><strong>Total Quantity Sold:</strong></td>
                        <td><strong>{{ total_quantity_sold }}</strong></td>
                        <td colspan="5" class="text-end"><strong>Total Sales:</strong></td>
                        <td><strong>{{ total_sales|floatformat:2 }}</strong></td>
                        <td colspan="4"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

{% elif report_type == 'purchase' %}
<!-- Purchase Report -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">Purchase Report</h5>
                <small class="text-muted">{{ start_date|date:"F j, Y" }} to {{ end_date|date:"F j, Y" }}</small>
                {% if applied_filters %}
                <div class="mt-2">
                    <span class="badge bg-info">Applied Filters: {{ applied_filters }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if group_by %}
        <div class="alert alert-info">
            <strong>Grouped by: {{ group_by_display }}</strong>
        </div>
        {% endif %}
        
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>UOM</th>
                        <th>Buying Price</th>
                        <th>VAT (%)</th>
                        <th>AIT (%)</th>
                        <th>Final Price</th>
                        <th>Total Price</th>
                        <th>Supplier</th>
                        <th>Reference</th>
                    </tr>
                </thead>
                <tbody>
                    {% if grouped_data %}
                        {% for group in grouped_data %}
                        <tr class="table-secondary">
                            <td colspan="12"><strong>{{ group.name }}</strong></td>
                        </tr>
                        {% for transaction in group.transactions %}
                        <tr>
                            <td>{{ transaction.id }}</td>
                            <td>{{ transaction.transaction_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ transaction.product.name }}</td>
                            <td>{{ transaction.quantity }}</td>
                            <td>{{ transaction.product.unit_of_measure }}</td>
                            <td>{{ transaction.buying_price }}</td>
                            <td>
                                {% if not transaction.apply_taxes %}
                                -
                                {% else %}
                                {{ transaction.vat_rate|default:"0" }}
                                {% endif %}
                            </td>
                            <td>
                                {% if not transaction.apply_taxes %}
                                -
                                {% else %}
                                {{ transaction.ait_rate|default:"0" }}
                                {% endif %}
                            </td>
                            <td>{% if transaction.apply_taxes and transaction.final_price %}{{ transaction.final_price }}{% else %}{{ transaction.buying_price }}{% endif %}</td>
                            <td>{{ transaction.total_price }}</td>
                            <td>{% if transaction.product.supplier %}{{ transaction.product.supplier.name }}{% else %}-{% endif %}</td>
                            <td>{{ transaction.reference_number|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-light">
                            <td colspan="9" class="text-end"><em>Subtotal:</em></td>
                            <td><em>{{ group.subtotal|floatformat:2 }}</em></td>
                            <td colspan="2"></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        {% for transaction in purchases %}
                        <tr>
                            <td>{{ transaction.id }}</td>
                            <td>{{ transaction.transaction_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ transaction.product.name }}</td>
                            <td>{{ transaction.quantity }}</td>
                            <td>{{ transaction.product.unit_of_measure }}</td>
                            <td>{{ transaction.buying_price }}</td>
                            <td>
                                {% if not transaction.apply_taxes %}
                                -
                                {% else %}
                                {{ transaction.vat_rate|default:"0" }}
                                {% endif %}
                            </td>
                            <td>
                                {% if not transaction.apply_taxes %}
                                -
                                {% else %}
                                {{ transaction.ait_rate|default:"0" }}
                                {% endif %}
                            </td>
                            <td>{% if transaction.apply_taxes and transaction.final_price %}{{ transaction.final_price }}{% else %}{{ transaction.buying_price }}{% endif %}</td>
                            <td>{{ transaction.total_price }}</td>
                            <td>{% if transaction.product.supplier %}{{ transaction.product.supplier.name }}{% else %}-{% endif %}</td>
                            <td>{{ transaction.reference_number|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="12" class="text-center">No purchase data available for the selected period.</td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
                <tfoot>
                    <tr class="table-dark">
                        <td colspan="2" class="text-end"><strong>Total Quantity Purchased:</strong></td>
                        <td><strong>{{ total_quantity_purchased }}</strong></td>
                        <td colspan="5" class="text-end"><strong>Total Purchases:</strong></td>
                        <td><strong>{{ total_purchases|floatformat:2 }}</strong></td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

{% elif report_type == 'wastage' %}
<!-- Wastage Report -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">Wastage Report</h5>
                <small class="text-muted">{{ start_date|date:"F j, Y" }} to {{ end_date|date:"F j, Y" }}</small>
                {% if applied_filters %}
                <div class="mt-2">
                    <span class="badge bg-info">Applied Filters: {{ applied_filters }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if group_by %}
        <div class="alert alert-info">
            <strong>Grouped by: {{ group_by_display }}</strong>
        </div>
        {% endif %}
        
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Type</th>
                        <th>Quantity</th>
                        <th>Buying Price</th>
                        <th>Unit Price</th>
                        <th>Wastage Amount</th>
                        <th>Profit/Loss</th>
                        <th>Total Price</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% if grouped_data %}
                        {% for group in grouped_data %}
                        <tr class="table-secondary">
                            <td colspan="11"><strong>{{ group.name }}</strong></td>
                        </tr>
                        {% for transaction in group.transactions %}
                        <tr>
                            <td>{{ transaction.id }}</td>
                            <td>{{ transaction.transaction_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ transaction.product.name }}</td>
                            <td>
                                {% if transaction.transaction_type == 'wastage' %}
                                <span class="badge bg-danger">Wastage</span>
                                {% elif transaction.transaction_type == 'in' %}
                                <span class="badge bg-warning">Purchase</span>
                                {% elif transaction.transaction_type == 'out' %}
                                <span class="badge bg-info">Sale</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ transaction.transaction_type }}</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.quantity }}</td>
                            <td>{{ transaction.buying_price }}</td>
                            <td>{{ transaction.unit_price }}</td>
                            <td>{{ transaction.wastage_amount }}</td>
                            <td>
                                {% if transaction.profit_loss > 0 %}
                                <span class="text-success">{{ transaction.profit_loss }}</span>
                                {% elif transaction.profit_loss < 0 %}
                                <span class="text-danger">{{ transaction.profit_loss|floatformat:2|cut:"-" }}</span>
                                {% else %}
                                <span>{{ transaction.profit_loss }}</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.total_price }}</td>
                            <td>{{ transaction.notes|truncatechars:50|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-light">
                            <td colspan="9" class="text-end"><em>Subtotal:</em></td>
                            <td><em>{{ group.subtotal|floatformat:2 }}</em></td>
                            <td></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        {% for transaction in wastage %}
                        <tr>
                            <td>{{ transaction.id }}</td>
                            <td>{{ transaction.transaction_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ transaction.product.name }}</td>
                            <td>
                                {% if transaction.transaction_type == 'wastage' %}
                                <span class="badge bg-danger">Wastage</span>
                                {% elif transaction.transaction_type == 'in' %}
                                <span class="badge bg-warning">Purchase</span>
                                {% elif transaction.transaction_type == 'out' %}
                                <span class="badge bg-info">Sale</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ transaction.transaction_type }}</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.quantity }}</td>
                            <td>{{ transaction.buying_price }}</td>
                            <td>{{ transaction.unit_price }}</td>
                            <td>{{ transaction.wastage_amount }}</td>
                            <td>
                                {% if transaction.profit_loss > 0 %}
                                <span class="text-success">{{ transaction.profit_loss }}</span>
                                {% elif transaction.profit_loss < 0 %}
                                <span class="text-danger">{{ transaction.profit_loss|floatformat:2|cut:"-" }}</span>
                                {% else %}
                                <span>{{ transaction.profit_loss }}</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.total_price }}</td>
                            <td>{{ transaction.notes|truncatechars:50|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center">No wastage data available for the selected period.</td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
                <tfoot>
                    <tr class="table-dark">
                        <td colspan="9" class="text-end"><strong>Total Wastage Value:</strong></td>
                        <td><strong>{{ total_wastage|floatformat:2 }}</strong></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="11" class="small text-muted ps-3">
                            <i class="fas fa-info-circle"></i> The total wastage value includes product costs (quantity × buying price) and any additional wastage costs.
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

{% elif report_type == 'payment' %}
<!-- Payment Report -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">Payment Report</h5>
                <small class="text-muted">{{ start_date|date:"F j, Y" }} to {{ end_date|date:"F j, Y" }}</small>
                {% if applied_filters %}
                <div class="mt-2">
                    <span class="badge bg-info">Applied Filters: {{ applied_filters }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if group_by %}
        <div class="alert alert-info">
            <strong>Grouped by: {{ group_by_display }}</strong>
        </div>
        {% endif %}
        
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Transaction Type</th>
                        <th>Quantity</th>
                        <th>Total Price</th>
                        <th>Payment Status</th>
                        <th>Amount Paid</th>
                        <th>Amount Due</th>
                        <th>Due Date</th>
                        <th>Client/Supplier</th>
                        <th>Reference</th>
                    </tr>
                </thead>
                <tbody>
                    {% if grouped_data %}
                        {% for group in grouped_data %}
                        <tr class="table-secondary">
                            <td colspan="12"><strong>{{ group.name }}</strong></td>
                        </tr>
                        {% for transaction in group.transactions %}
                        <tr>
                            <td>{{ transaction.id }}</td>
                            <td>{{ transaction.transaction_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ transaction.product.name }}</td>
                            <td>
                                {% if transaction.transaction_type == 'in' %}
                                <span class="badge bg-primary">Stock In</span>
                                {% elif transaction.transaction_type == 'out' %}
                                <span class="badge bg-info">Stock Out</span>
                                {% elif transaction.transaction_type == 'return' %}
                                <span class="badge bg-warning">Return</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ transaction.get_transaction_type_display }}</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.quantity }}</td>
                            <td>{{ transaction.total_price }}</td>
                            <td>
                                {% if transaction.payment_status == 'paid' %}
                                <span class="badge bg-success">Paid</span>
                                {% elif transaction.payment_status == 'due' %}
                                <span class="badge bg-danger">Due</span>
                                {% elif transaction.payment_status == 'partial' %}
                                <span class="badge bg-warning">Partially Paid</span>
                                {% elif transaction.payment_status == 'credit' %}
                                <span class="badge bg-info">Credit</span>
                                {% else %}
                                <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.amount_paid }}</td>
                            <td>{{ transaction.amount_due }}</td>
                            <td>{% if transaction.payment_due_date %}{{ transaction.payment_due_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                            <td>
                                {% if transaction.transaction_type == 'out' or transaction.transaction_type == 'return' %}
                                    {% if transaction.client %}{{ transaction.client.name }}{% else %}-{% endif %}
                                {% elif transaction.transaction_type == 'in' %}
                                    {% if transaction.supplier %}{{ transaction.supplier.name }}{% else %}-{% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ transaction.reference_number|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-light">
                            <td colspan="7" class="text-end"><em>Subtotal Amount Due:</em></td>
                            <td><em>{{ group.total_paid|floatformat:2 }}</em></td>
                            <td><em>{{ group.total_due|floatformat:2 }}</em></td>
                            <td colspan="3"></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        {% for transaction in payment_transactions %}
                        <tr>
                            <td>{{ transaction.id }}</td>
                            <td>{{ transaction.transaction_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ transaction.product.name }}</td>
                            <td>
                                {% if transaction.transaction_type == 'in' %}
                                <span class="badge bg-primary">Stock In</span>
                                {% elif transaction.transaction_type == 'out' %}
                                <span class="badge bg-info">Stock Out</span>
                                {% elif transaction.transaction_type == 'return' %}
                                <span class="badge bg-warning">Return</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ transaction.get_transaction_type_display }}</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.quantity }}</td>
                            <td>{{ transaction.total_price }}</td>
                            <td>
                                {% if transaction.payment_status == 'paid' %}
                                <span class="badge bg-success">Paid</span>
                                {% elif transaction.payment_status == 'due' %}
                                <span class="badge bg-danger">Due</span>
                                {% elif transaction.payment_status == 'partial' %}
                                <span class="badge bg-warning">Partially Paid</span>
                                {% elif transaction.payment_status == 'credit' %}
                                <span class="badge bg-info">Credit</span>
                                {% else %}
                                <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.amount_paid }}</td>
                            <td>{{ transaction.amount_due }}</td>
                            <td>{% if transaction.payment_due_date %}{{ transaction.payment_due_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                            <td>
                                {% if transaction.transaction_type == 'out' or transaction.transaction_type == 'return' %}
                                    {% if transaction.client %}{{ transaction.client.name }}{% else %}-{% endif %}
                                {% elif transaction.transaction_type == 'in' %}
                                    {% if transaction.supplier %}{{ transaction.supplier.name }}{% else %}-{% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ transaction.reference_number|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="12" class="text-center">No payment data available for the selected period.</td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
                <tfoot>
                    <tr class="table-dark">
                        <td colspan="7" class="text-end"><strong>Total:</strong></td>
                        <td><strong>{{ total_paid|floatformat:2 }}</strong></td>
                        <td><strong>{{ total_due|floatformat:2 }}</strong></td>
                        <td colspan="3"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Payment Detail Report -->
        {% if payment_records %}
        <div class="mt-4">
            <h5>Payment Transactions</h5>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>Transaction ID</th>
                            <th>Product</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Reference</th>
                            <th>Created By</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payment_records %}
                        <tr>
                            <td>{{ payment.id }}</td>
                            <td>{{ payment.payment_date|date:"Y-m-d" }}</td>
                            <td>{{ payment.transaction.id }}</td>
                            <td>{{ payment.transaction.product.name }}</td>
                            <td>{{ payment.amount }}</td>
                            <td>{{ payment.get_payment_method_display }}</td>
                            <td>{{ payment.reference|default:"-" }}</td>
                            <td>{{ payment.created_by.username }}</td>
                            <td>{{ payment.notes|truncatechars:50|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-dark">
                            <td colspan="4" class="text-end"><strong>Total Payments:</strong></td>
                            <td><strong>{{ total_payments|floatformat:2 }}</strong></td>
                            <td colspan="4"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% else %}
<div class="alert alert-warning">
    <h4 class="alert-heading">Unknown Report Type</h4>
    <p>The requested report type is not available. Please select a valid report type from the options above.</p>
</div>
{% endif %}

<!-- PDF Customization Modal -->
<div class="modal fade" id="pdfCustomizationModal" tabindex="-1" role="dialog" aria-labelledby="pdfCustomizationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pdfCustomizationModalLabel">Customize PDF Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="pdfCustomizationForm" action="{% url 'customize_pdf' %}" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" name="pdf_type" id="pdf_type" value="report">
          <input type="hidden" name="item_id" id="item_id" value="">
          
          <div class="form-group">
            <label for="company_name">Company Name</label>
            <input type="text" class="form-control" id="company_name" name="company_name" value="QBITX IMS">
          </div>
          
          <div class="form-group">
            <label for="company_tagline">Company Tagline</label>
            <input type="text" class="form-control" id="company_tagline" name="company_tagline" value="Transform Suppliers">
          </div>
          
          <div class="form-group">
            <label for="company_details">Company Details</label>
            <textarea class="form-control" id="company_details" name="company_details" rows="3">123 Business Street, Business City, Country
Phone: (123) 456-7890 | Email: info@qbitx-ims.com</textarea>
          </div>
          
          <div class="form-group">
            <label for="terms_conditions">Terms and Conditions</label>
            <textarea class="form-control" id="terms_conditions" name="terms_conditions" rows="5">1. This report is generated from the QBITX Inventory Management System.
2. All values are displayed in the default currency.
3. For any questions regarding this report, please contact the system administrator.</textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Generate PDF</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Update the script to use a more direct approach -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // When download PDF button is clicked
    var downloadButtons = document.querySelectorAll('.download-pdf-btn');
    downloadButtons.forEach(function(button) {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        var reportType = this.getAttribute('data-report-type');
        
        // Get current URL parameters for filters
        var urlParams = new URLSearchParams(window.location.search);
        
        // Set the report type and item_id
        document.getElementById('pdf_type').value = 'report';
        document.getElementById('item_id').value = reportType;
        
        // Add hidden fields for all current filters to the form
        var modalForm = document.getElementById('pdfCustomizationForm');
        
        // Clear any previously added filter fields
        var tempFields = document.querySelectorAll('.temp-filter-field');
        tempFields.forEach(function(field) {
          field.remove();
        });
        
        // Add all current URL parameters as hidden fields
        urlParams.forEach(function(value, key) {
          if (key !== 'type') { // Skip the 'type' parameter as it's handled separately
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            input.className = 'temp-filter-field';
            modalForm.appendChild(input);
          }
        });
        
        // Show the modal using vanilla JS
        var modal = document.getElementById('pdfCustomizationModal');
        modal.classList.add('show');
        modal.style.display = 'block';
        modal.setAttribute('aria-modal', 'true');
        modal.setAttribute('role', 'dialog');
        document.body.classList.add('modal-open');
        
        // Add backdrop
        var backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);
      });
    });
    
    // Close modal functionality
    var closeButtons = document.querySelectorAll('[data-bs-dismiss="modal"]');
    closeButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        closeModal();
      });
    });
    
    // Function to close the modal
    function closeModal() {
      var modal = document.getElementById('pdfCustomizationModal');
      modal.classList.remove('show');
      modal.style.display = 'none';
      modal.removeAttribute('aria-modal');
      modal.setAttribute('role', '');
      document.body.classList.remove('modal-open');
      
      // Remove backdrop
      var backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }
    }
  });
</script>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Show filter collapse if any filters are applied
        var filterCollapse = document.getElementById('filterCollapse');
        if (filterCollapse && filterCollapse.dataset.showFilters === 'true') {
            var bsCollapse = new bootstrap.Collapse(filterCollapse);
            bsCollapse.show();
        }
    });
</script>
{% endblock %} 