{% extends 'base.html' %}
{% load static %}

{% block title %}Add Stock Transaction - QBITX IMS Transform Suppliers{% endblock %}

{% block extra_css %}
<style>
    .card-header {
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    .card-header .card-title {
        margin-bottom: 0;
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        color: #fff !important;
    }
    .card-body {
        padding: 1.25rem;
    }
    #productInfoCard .card-header,
    #transactionDetailsCard .card-header,
    #transactionPreviewCard .card-header {
        display: flex;
        align-items: center;
        min-height: 3rem;
    }
    .table-sm th, .table-sm td {
        padding: 0.3rem;
    }
    .bg-primary {
        background-color: #007bff !important;
    }
    .bg-info {
        background-color: #17a2b8 !important;
    }
    .bg-success {
        background-color: #28a745 !important;
    }
    .text-white {
        color: #fff !important;
    }
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
        border-radius: 0.25rem;
    }
    .card-header .fas {
        font-size: 1.2rem;
        color: #fff !important;
    }
    .me-2 {
        margin-right: 0.5rem !important;
    }
    .fw-bold {
        font-weight: 700 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'stock' %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Stock Transactions
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
<div class="card">
    <div class="card-body">
        <form method="post" id="stockTransactionForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                {{ error }}
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Hidden fields for tax data -->
            {{ form.apply_taxes }}
            {{ form.vat_rate }}
            {{ form.ait_rate }}
            {{ form.final_price }}
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.transaction_type.id_for_label }}" class="form-label">Transaction Type</label>
                    {{ form.transaction_type }}
                    {% if form.transaction_type.errors %}
                        <div class="form-error">{{ form.transaction_type.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.transaction_date.id_for_label }}" class="form-label">Transaction Date</label>
                    {{ form.transaction_date }}
                    {% if form.transaction_date.errors %}
                        <div class="form-error">{{ form.transaction_date.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.source_warehouse.id_for_label }}" class="form-label">Source Warehouse</label>
                    {{ form.source_warehouse }}
                    {% if form.source_warehouse.errors %}
                        <div class="form-error">{{ form.source_warehouse.errors.0 }}</div>
                    {% endif %}
                    <small class="form-text text-muted">Required for stock out, wastage, and transfers</small>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.destination_warehouse.id_for_label }}" class="form-label">Destination Warehouse</label>
                    {{ form.destination_warehouse }}
                    {% if form.destination_warehouse.errors %}
                        <div class="form-error">{{ form.destination_warehouse.errors.0 }}</div>
                    {% endif %}
                    <small class="form-text text-muted">Required for stock in, returns, and transfers</small>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="product_category" class="form-label">Product Category</label>
                    <select id="product_category" class="form-select">
                        <option value="">Select Warehouse First</option>
                    </select>
                    <small class="form-text text-muted">Categories available in the selected warehouse</small>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.product.id_for_label }}" class="form-label">Product</label>
                    {{ form.product }}
                    {% if form.product.errors %}
                        <div class="form-error">{{ form.product.errors.0 }}</div>
                    {% endif %}
                    <small class="form-text text-muted">Products available in the selected category and warehouse</small>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.quantity.id_for_label }}" class="form-label">Quantity</label>
                    {{ form.quantity }}
                    {% if form.quantity.errors %}
                        <div class="form-error">{{ form.quantity.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.wastage_amount.id_for_label }}" class="form-label">Wastage Amount</label>
                    {{ form.wastage_amount }}
                    {% if form.wastage_amount.errors %}
                        <div class="form-error">{{ form.wastage_amount.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.buying_price.id_for_label }}" class="form-label">Buying Price</label>
                    {{ form.buying_price }}
                    {% if form.buying_price.errors %}
                        <div class="form-error">{{ form.buying_price.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="{{ form.selling_price.id_for_label }}" class="form-label">Selling Price</label>
                    {{ form.selling_price }}
                    {% if form.selling_price.errors %}
                        <div class="form-error">{{ form.selling_price.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Tax Options (Always visible) -->
            <div id="taxOptionsSection" class="mb-3 border rounded p-3 bg-light">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="applyTaxes" name="apply_taxes">
                    <label class="form-check-label" for="applyTaxes">
                        Apply Tax Deductions
                    </label>
                </div>
                
                <div id="taxDetails" class="mt-3" style="display: none;">
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="vatRate" class="form-label">VAT Rate (%)</label>
                            <input type="number" class="form-control" id="vatRate" name="vat_rate" value="9.1" step="0.1">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="aitRate" class="form-label">AIT Rate (%)</label>
                            <input type="number" class="form-control" id="aitRate" name="ait_rate" value="5.0" step="0.1">
                </div>
            </div>
            
                            <div class="alert alert-info mt-2">
                                <p class="mb-1"><strong>Tax Calculation:</strong></p>
                                <p class="mb-1">1. VAT (<span id="vatRateDisplay">9.1</span>%) will be deducted from selling price</p>
                                <p class="mb-1">2. AIT (<span id="aitRateDisplay">5.0</span>%) will be deducted from the remaining amount</p>
                                <p class="mb-0">3. Final payable amount will be used for profit calculation</p>
                            </div>
                            
                            <div class="mt-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1">Original Price: <span id="originalPriceDisplay">0.00</span></p>
                                        <p class="mb-1">After VAT: <span id="afterVatDisplay">0.00</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1">After AIT: <span id="afterAitDisplay">0.00</span></p>
                                        <p class="mb-1"><strong>Final Price: <span id="finalPriceDisplay">0.00</span></strong></p>
                                    </div>
                                </div>
                                <input type="hidden" id="finalPrice" name="final_price" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.supplier.id_for_label }}" class="form-label">Supplier</label>
                            {{ form.supplier }}
                            {% if form.supplier.errors %}
                                <div class="form-error">{{ form.supplier.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.client.id_for_label }}" class="form-label">Client</label>
                            <div class="input-group">
                                {{ form.client }}
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#createClientModal" id="createClientBtn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            {% if form.client.errors %}
                                <div class="form-error">{{ form.client.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.reference_number.id_for_label }}" class="form-label">Reference Number</label>
                        {{ form.reference_number }}
                        {% if form.reference_number.errors %}
                            <div class="form-error">{{ form.reference_number.errors.0 }}</div>
                        {% endif %}
            </div>
            
                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                            <div class="form-error">{{ form.notes.errors.0 }}</div>
                        {% endif %}
                    </div>
            
                    <!-- Payment Options Section -->
                    <div id="paymentOptionsSection" class="mb-4 border rounded p-3 bg-light">
                        <h5 class="mb-3">Payment Information</h5>
                        
                        <div class="mb-3">
                            <label for="{{ form.payment_status.id_for_label }}" class="form-label">Payment Status</label>
                            {{ form.payment_status }}
                            {% if form.payment_status.errors %}
                                <div class="form-error">{{ form.payment_status.errors.0 }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Select the payment status for this transaction.</small>
                        </div>
                        
                        <div id="paymentDueDateField" class="mb-3">
                            <label for="{{ form.payment_due_date.id_for_label }}" class="form-label">Payment Due Date</label>
                            {{ form.payment_due_date }}
                            {% if form.payment_due_date.errors %}
                                <div class="form-error">{{ form.payment_due_date.errors.0 }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Required for due, partial, or credit payments.</small>
                        </div>
                        
                        <div id="amountPaidField" class="mb-3">
                            <label for="{{ form.amount_paid.id_for_label }}" class="form-label">Amount Paid</label>
                            {{ form.amount_paid }}
                            {% if form.amount_paid.errors %}
                                <div class="form-error">{{ form.amount_paid.errors.0 }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Required for partial payments.</small>
                        </div>
                        
                        <div class="alert alert-info mt-2">
                            <p class="mb-1"><strong>Payment Status Information:</strong></p>
                            <p class="mb-1">• <strong>Paid:</strong> Full payment received at time of transaction</p>
                            <p class="mb-1">• <strong>Due:</strong> Full payment pending, with a future due date</p>
                            <p class="mb-1">• <strong>Partially Paid:</strong> Some payment received, with balance due</p>
                            <p class="mb-0">• <strong>Credit:</strong> Payment arrangement with special terms</p>
                </div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save
                </button>
            </div>
        </form>
    </div>
    </div>
</div>

    <div class="col-md-4">
        <!-- Product Information Card -->
        <div class="card mb-4" id="productInfoCard" style="display: none;">
            <div class="card-header bg-primary text-white d-flex align-items-center">
                <i class="fas fa-box-open me-2"></i>
                <h5 class="card-title mb-0 fw-bold">Product Information</h5>
            </div>
            <div class="card-body">
                <div id="productInfo">
                    <h5 id="productName" class="mb-3">-</h5>
                    <p><strong>SKU:</strong> <span id="productSku">-</span></p>
                    <p><strong>Category:</strong> <span id="productCategory">-</span></p>
                    <p><strong>Current Stock:</strong> <span id="productQuantity">-</span> <span id="productUom">-</span></p>
                    <p><strong>Buying Price:</strong> <span id="productBuyingPrice">-</span></p>
                    <p><strong>Selling Price:</strong> <span id="productSellingPrice">-</span></p>
                    <p><strong>Profit Margin:</strong> <span id="productProfitMargin">-</span>%</p>
                    <p><strong>Warehouse:</strong> <span id="productWarehouse">-</span></p>
                </div>
            </div>
        </div>

        <!-- Transaction Details Card -->
        <div class="card mb-4" id="transactionDetailsCard" style="display: none;">
            <div class="card-header bg-info text-white d-flex align-items-center">
                <i class="fas fa-history me-2"></i>
                <h5 class="card-title mb-0 fw-bold">Recent Transactions</h5>
            </div>
            <div class="card-body">
                <div id="transactionDetails">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Qty</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList">
                                <tr>
                                    <td colspan="5" class="text-center">Select a product to view transactions</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">Showing recent transactions for this product</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Preview Card -->
        <div class="card mb-4" id="transactionPreviewCard">
            <div class="card-header bg-success text-white d-flex align-items-center">
                <i class="fas fa-calculator me-2"></i>
                <h5 class="card-title mb-0 fw-bold">Transaction Preview</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i> This preview shows the calculated values for the current transaction.
                </div>
                <div id="transactionPreview">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Quantity:</strong> <span id="previewQuantity">0</span></p>
                            <p><strong>Unit Price:</strong> <span id="previewUnitPrice">0.00</span></p>
                            <p><strong>Total Price:</strong> <span id="previewTotalPrice" class="text-success fw-bold">0.00</span></p>
                        </div>
                        <div class="col-6">
                            <p><strong>Transaction Type:</strong> <span id="previewType">-</span></p>
                            <p><strong>Payment Status:</strong> <span id="previewPaymentStatus">-</span></p>
                            <p><strong>Warehouse:</strong> <span id="previewWarehouse">-</span></p>
                        </div>
                    </div>
                    <div class="mt-3" id="taxPreviewSection" style="display: none;">
                        <h6 class="border-bottom pb-2">Tax Calculations</h6>
                        <div class="row">
                            <div class="col-6">
                                <p><strong>VAT Deduction:</strong> <span id="previewVatDeduction">0.00</span></p>
                                <p><strong>AIT Deduction:</strong> <span id="previewAitDeduction">0.00</span></p>
                            </div>
                            <div class="col-6">
                                <p><strong>After Taxes:</strong> <span id="previewAfterTaxes">0.00</span></p>
                                <p><strong>Net Profit:</strong> <span id="previewProfit">0.00</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Types Card -->
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-exchange-alt me-2"></i>
                <h5 class="card-title mb-0 fw-bold">Transaction Types</h5>
            </div>
            <div class="card-body">
                <p><strong>Stock In:</strong> Add new inventory to the warehouse.</p>
                <p><strong>Stock Out:</strong> Remove inventory for sales or other purposes.</p>
                <p><strong>Wastage:</strong> Record damaged or expired inventory.</p>
                <p><strong>Return:</strong> Record returned items from customers.</p>
                <p><strong>Warehouse Transfer:</strong> Move inventory between warehouses.</p>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i> The form will update automatically based on the transaction type selected.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Client Modal -->
<div class="modal fade" id="createClientModal" tabindex="-1" aria-labelledby="createClientModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createClientModalLabel">Create New Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <div class="mb-3">
                        <label for="clientName" class="form-label">Client Name</label>
                        <input type="text" class="form-control" id="clientName" required>
                    </div>
                    <div class="mb-3">
                        <label for="contactPerson" class="form-label">Contact Person</label>
                        <input type="text" class="form-control" id="contactPerson">
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="clientEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="clientEmail">
                        </div>
                        <div class="col-md-6">
                            <label for="clientPhone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="clientPhone">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="clientAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="clientAddress" rows="2"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="clientCity" class="form-label">City</label>
                            <input type="text" class="form-control" id="clientCity">
                        </div>
                        <div class="col-md-6">
                            <label for="clientCountry" class="form-label">Country</label>
                            <input type="text" class="form-control" id="clientCountry">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="clientNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="clientNotes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveClientBtn">Create Client</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/stock.js' %}"></script>
<script>
$(document).ready(function() {
    // Initialize form fields based on transaction type
    updateFormFields();
    
    // Load categories based on selected warehouse
    function loadCategoriesByWarehouse() {
        // Determine which warehouse to use based on transaction type
        const transactionType = $('#id_transaction_type').val();
        let warehouseId = null;
        
        if (transactionType === 'in' || transactionType === 'return') {
            warehouseId = $('#id_destination_warehouse').val();
        } else if (transactionType === 'out' || transactionType === 'wastage') {
            warehouseId = $('#id_source_warehouse').val();
        } else if (transactionType === 'transfer') {
            // For transfers, use source warehouse for filtering
            warehouseId = $('#id_source_warehouse').val();
        }
        
        if (!warehouseId) {
            // If no warehouse selected, clear categories
            $('#product_category').html('<option value="">Select Warehouse First</option>');
            return;
        }
        
        // Show loading indicator
        $('#product_category').html('<option value="">Loading...</option>');
        
        // Get categories for the selected warehouse
        $.ajax({
            url: '{% url "products" %}',
            data: {
                'warehouse': warehouseId,
                'format': 'json'
            },
            dataType: 'json',
            success: function(data) {
                // Extract unique categories from products
                const categories = {};
                data.forEach(function(product) {
                    if (product.category_id && product.category_name) {
                        categories[product.category_id] = product.category_name;
                    }
                });
                
                // Update category dropdown
                const $categorySelect = $('#product_category');
                
                // If no products found in this warehouse
                if (data.length === 0) {
                    $categorySelect.html('<option value="">No Products in this Warehouse</option>');
                    $('#id_product').html('<option value="">No Products Available</option>');
                    return;
                }
                
                $categorySelect.html('<option value="">All Categories</option>');
                
                // Add categories to dropdown
                Object.keys(categories).forEach(function(categoryId) {
                    $categorySelect.append(
                        $('<option></option>')
                            .attr('value', categoryId)
                            .text(categories[categoryId])
                    );
                });
                
                // If no categories found
                if (Object.keys(categories).length === 0) {
                    $categorySelect.html('<option value="">No Categories Available</option>');
                }
                
                // Trigger change to update products
                $categorySelect.trigger('change');
            },
            error: function() {
                $('#product_category').html('<option value="">Error loading categories</option>');
            }
        });
    }
    
    // Load products based on selected warehouse and category
    function loadProductsByWarehouseAndCategory() {
        // Determine which warehouse to use based on transaction type
        const transactionType = $('#id_transaction_type').val();
        let warehouseId = null;
        
        if (transactionType === 'in' || transactionType === 'return') {
            warehouseId = $('#id_destination_warehouse').val();
        } else if (transactionType === 'out' || transactionType === 'wastage') {
            warehouseId = $('#id_source_warehouse').val();
        } else if (transactionType === 'transfer') {
            // For transfers, use source warehouse for filtering
            warehouseId = $('#id_source_warehouse').val();
        }
        
        const categoryId = $('#product_category').val();
        const $productSelect = $('#id_product');
        
        // Store current selection if possible
        const currentProduct = $productSelect.val();
        
        // Show loading indicator
        $productSelect.html('<option value="">Loading...</option>');
        
        // Build query parameters
        const queryParams = { 'format': 'json' };
        if (warehouseId) {
            queryParams['warehouse'] = warehouseId;
        }
        if (categoryId) {
            queryParams['category'] = categoryId;
        }
        
        // Get products filtered by warehouse and category
        $.ajax({
            url: '{% url "products" %}',
            data: queryParams,
            dataType: 'json',
            success: function(data) {
                $productSelect.html('<option value="">Select Product</option>');
                
                // Add products to dropdown
                $.each(data, function(index, product) {
                    var optionText = product.name;
                    if (product.sku) {
                        optionText += ' (' + product.sku + ')';
                    }
                    
                    var option = $('<option></option>')
                        .attr('value', product.id)
                        .text(optionText)
                        .data('product', product);
                        
                    $productSelect.append(option);
                });
                
                // Try to restore previous selection
                if (currentProduct) {
                    // Check if the previously selected product is still in the list
                    var productStillExists = false;
                    $productSelect.find('option').each(function() {
                        if ($(this).val() === currentProduct) {
                            productStillExists = true;
                            return false; // Break the loop
                        }
                    });
                    
                    if (productStillExists) {
                        $productSelect.val(currentProduct);
                        // Trigger change to update product info
                        $productSelect.trigger('change');
                    } else {
                        // Clear product info if the product is no longer available
                        document.getElementById('productInfoCard').style.display = 'none';
                        document.getElementById('transactionDetailsCard').style.display = 'none';
                    }
                }
            },
            error: function() {
                $productSelect.html('<option value="">Error loading products</option>');
            }
        });
    }
    
    // Add event listeners for warehouse changes
    $('#id_source_warehouse, #id_destination_warehouse').change(function() {
        loadCategoriesByWarehouse();
    });
    
    // Filter products by category
    $('#product_category').change(function() {
        loadProductsByWarehouseAndCategory();
    });
    
    // Initialize tax options section if transaction type is 'out'
    const transactionType = document.getElementById('id_transaction_type').value;
    if (transactionType === 'out') {
        const taxOptionsSection = document.getElementById('taxOptionsSection');
        if (taxOptionsSection) {
            taxOptionsSection.style.display = 'block';
        }
        
        // Show the create client button only for stock out transactions
        const createClientBtn = document.getElementById('createClientBtn');
        if (createClientBtn) {
            createClientBtn.style.display = 'block';
        }
    } else {
        // Hide the create client button for non-stock-out transactions
        const createClientBtn = document.getElementById('createClientBtn');
        if (createClientBtn) {
            createClientBtn.style.display = 'none';
        }
    }
    
    // Handle transaction type change to show/hide client button and update warehouse fields
    const transactionTypeSelect = document.getElementById('id_transaction_type');
    if (transactionTypeSelect) {
        transactionTypeSelect.addEventListener('change', function() {
            updateFormFields();
            loadCategoriesByWarehouse();
            
            const createClientBtn = document.getElementById('createClientBtn');
            if (createClientBtn) {
                if (this.value === 'out') {
                    createClientBtn.style.display = 'block';
                } else {
                    createClientBtn.style.display = 'none';
                }
            }
        });
    }
    
    // Initialize warehouses based on transaction type
    loadCategoriesByWarehouse();
    
    // Handle client creation
    const saveClientBtn = document.getElementById('saveClientBtn');
    if (saveClientBtn) {
        saveClientBtn.addEventListener('click', function() {
            const name = document.getElementById('clientName').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const email = document.getElementById('clientEmail').value;
            const phone = document.getElementById('clientPhone').value;
            const address = document.getElementById('clientAddress').value;
            const city = document.getElementById('clientCity').value;
            const country = document.getElementById('clientCountry').value;
            const notes = document.getElementById('clientNotes').value;
            
            if (!name) {
                alert('Client name is required');
                return;
            }
            
            // Send AJAX request to create client
            fetch('/imstransform/clients/create/ajax/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    name: name,
                    contact_person: contactPerson,
                    email: email,
                    phone: phone,
                    address: address,
                    city: city,
                    country: country,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add new client to select dropdown
                    const clientSelect = document.getElementById('id_client');
                    const option = new Option(data.client.name, data.client.id);
                    clientSelect.add(option);
                    clientSelect.value = data.client.id;
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createClientModal'));
                    modal.hide();
                    
                    // Show success message
                    alert('Client created successfully');
                } else {
                    alert('Error creating client: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while creating the client');
            });
        });
    }

    // Handle product selection to display product info and transaction history
    const productSelect = document.getElementById('id_product');
    const productInfoCard = document.getElementById('productInfoCard');
    const transactionDetailsCard = document.getElementById('transactionDetailsCard');
    
    if (productSelect) {
        productSelect.addEventListener('change', function() {
            if (this.value) {
                // Clear any previous product info
                productInfoCard.style.display = 'none';
                transactionDetailsCard.style.display = 'none';
                
                // Get the selected product data and update prices
                updateProductPrices();
            } else {
                productInfoCard.style.display = 'none';
                transactionDetailsCard.style.display = 'none';
            }
        });
        
        // Check if a product is already selected on page load
        if (productSelect.value) {
            updateProductPrices();
        }
    }
    
    // Function to fetch product details
    function fetchProductDetails(productId) {
        fetch(`/imstransform/products/?format=json&search=${productId}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const product = data[0];
                    
                    // Update product info card
                    document.getElementById('productName').textContent = product.name;
                    document.getElementById('productSku').textContent = product.sku;
                    document.getElementById('productCategory').textContent = product.category_name || '-';
                    document.getElementById('productQuantity').textContent = product.quantity;
                    document.getElementById('productUom').textContent = product.unit_of_measure;
                    document.getElementById('productBuyingPrice').textContent = product.buying_price;
                    document.getElementById('productSellingPrice').textContent = product.selling_price;
                    
                    // Calculate profit margin
                    const buyingPrice = parseFloat(product.buying_price);
                    const sellingPrice = parseFloat(product.selling_price);
                    let profitMargin = 0;
                    
                    if (buyingPrice > 0) {
                        profitMargin = ((sellingPrice - buyingPrice) / buyingPrice) * 100;
                    }
                    
                    document.getElementById('productProfitMargin').textContent = profitMargin.toFixed(2);
                    document.getElementById('productWarehouse').textContent = product.warehouse_name || '-';
                    
                    // Show product info card
                    productInfoCard.style.display = 'block';
                    
                    // Update form fields with product values
                    document.getElementById('id_buying_price').value = product.buying_price;
                    document.getElementById('id_selling_price').value = product.selling_price;
                    
                    // If product has a warehouse, set source warehouse
                    if (product.warehouse_id) {
                        const sourceWarehouseSelect = document.getElementById('id_source_warehouse');
                        if (sourceWarehouseSelect) {
                            sourceWarehouseSelect.value = product.warehouse_id;
                        }
                    }
                    
                    // Calculate taxes if applicable
                    if (typeof calculateTaxes === 'function') {
                        calculateTaxes();
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching product details:', error);
                productInfoCard.style.display = 'none';
            });
    }
    
    // Function to fetch transaction details
    function fetchTransactionDetails(productId) {
        const transactionsList = document.getElementById('transactionsList');
        
        // Show loading indicator
        transactionsList.innerHTML = '<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading transactions...</td></tr>';
        transactionDetailsCard.style.display = 'block';
        
        fetch(`/imstransform/stock/?format=json&product_id=${productId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Clear the transactions list
                transactionsList.innerHTML = '';
                
                if (data && data.length > 0) {
                    // Sort transactions by date (newest first)
                    data.sort((a, b) => new Date(b.transaction_date) - new Date(a.transaction_date));
                    
                    // Take only the 5 most recent transactions
                    const recentTransactions = data.slice(0, 5);
                    
                    // Add each transaction to the list
                    recentTransactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        
                        // Format the date
                        const transactionDate = new Date(transaction.transaction_date);
                        const formattedDate = transactionDate.toLocaleDateString() + ' ' + 
                                            transactionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        // Determine the badge class based on transaction type
                        let typeClass = 'bg-secondary';
                        if (transaction.transaction_type === 'in') typeClass = 'bg-primary';
                        if (transaction.transaction_type === 'out') typeClass = 'bg-info';
                        if (transaction.transaction_type === 'wastage') typeClass = 'bg-danger';
                        if (transaction.transaction_type === 'return') typeClass = 'bg-warning';
                        if (transaction.transaction_type === 'transfer') typeClass = 'bg-success';
                        
                        // Determine the payment status badge class
                        let statusClass = 'bg-secondary';
                        if (transaction.payment_status === 'paid') statusClass = 'bg-success';
                        if (transaction.payment_status === 'due') statusClass = 'bg-danger';
                        if (transaction.payment_status === 'partial') statusClass = 'bg-warning';
                        if (transaction.payment_status === 'credit') statusClass = 'bg-info';
                        
                        // Get transaction type display name
                        let typeDisplay = transaction.transaction_type.charAt(0).toUpperCase() + transaction.transaction_type.slice(1);
                        
                        // Get payment status display name
                        let statusDisplay = 'N/A';
                        if (transaction.payment_status === 'paid') statusDisplay = 'Paid';
                        if (transaction.payment_status === 'due') statusDisplay = 'Due';
                        if (transaction.payment_status === 'partial') statusDisplay = 'Partial';
                        if (transaction.payment_status === 'credit') statusDisplay = 'Credit';
                        
                        // Create the row content
                        row.innerHTML = `
                            <td>${transaction.id}</td>
                            <td>${formattedDate}</td>
                            <td><span class="badge ${typeClass}">${typeDisplay}</span></td>
                            <td>${transaction.quantity}</td>
                            <td><span class="badge ${statusClass}">${statusDisplay}</span></td>
                        `;
                        
                        transactionsList.appendChild(row);
                    });
        } else {
                    // No transactions found
                    transactionsList.innerHTML = '<tr><td colspan="5" class="text-center">No transactions found for this product</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error fetching transaction data:', error);
                transactionsList.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading transactions</td></tr>';
            });
    }
});
</script>
{% endblock %} 