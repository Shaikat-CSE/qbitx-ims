{% load inventory_extras %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <style>
        @page {
            size: a4 portrait;
            margin: 1.5cm;
        }
        body {
            font-family: Arial, sans-serif;
            font-size: 9pt;
            color: #333333;
            line-height: 1.2;
        }
        .header {
            text-align: center;
            margin-bottom: 15px;
        }
        .company-name {
            font-size: 16pt;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .company-tagline {
            font-size: 10pt;
            margin-bottom: 5px;
        }
        .company-details {
            font-size: 8pt;
        }
        .report-info {
            margin-bottom: 15px;
        }
        .report-title {
            font-size: 14pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 3px;
        }
        .report-subtitle {
            font-size: 10pt;
            text-align: center;
            margin-bottom: 5px;
        }
        .report-date {
            font-size: 8pt;
            text-align: center;
        }
        .filters-box {
            border: 1px solid #ddd;
            padding: 5px;
            margin-bottom: 10px;
            font-size: 8pt;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 7pt;
        }
        th, td {
            border: 0.5px solid #ddd;
            padding: 3px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .text-right {
            text-align: right;
        }
        .text-center {
            text-align: center;
        }
        .total-row {
            font-weight: bold;
        }
        .group-header {
            background-color: #eee;
            font-weight: bold;
        }
        .subtotal-row {
            background-color: #f9f9f9;
            font-style: italic;
        }
        .footer {
            margin-top: 15px;
            text-align: center;
            font-size: 7pt;
            color: #666;
        }
        .terms {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            font-size: 7pt;
        }
        .terms-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        /* Optimize table columns */
        .col-date { width: 10%; }
        .col-product { width: 15%; }
        .col-qty { width: 5%; }
        .col-uom { width: 5%; }
        .col-price { width: 8%; }
        .col-total { width: 8%; }
        .col-client { width: 12%; }
        .col-ref { width: 8%; }
        .col-notes { width: 15%; }
    </style>
</head>
<body>
    <div class="header">
        <div class="company-name">{{ company_name|default:"QBITX IMS" }}</div>
        <div class="company-tagline">{{ company_tagline|default:"Transform Suppliers" }}</div>
        <div class="company-details">
            {{ company_details|default:"123 Business Street, Business City, Country<br>Phone: (123) 456-7890 | Email: info@qbitx-ims.com"|safe }}
        </div>
    </div>

    <div class="report-info">
        <div class="report-title">{{ report_title }}</div>
        <div class="report-subtitle">{{ report_subtitle }}</div>
        <div class="report-date">Generated on: {{ generation_date }}</div>
    </div>

    {% if applied_filters %}
    <div class="filters-box">
        <strong>Applied Filters:</strong> {{ applied_filters }}
    </div>
    {% endif %}

    {% if report_type == 'inventory' %}
    <h2>{{ report_title }}</h2>
    <p class="subtitle">{{ report_subtitle }}</p>

    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>SKU</th>
                <th>Category</th>
                <th>Supplier</th>
                <th>Opening Stock</th>
                <th>Purchase Stock</th>
                <th>Total Stock</th>
                <th>Sale Stock</th>
                <th>Wastage Stock</th>
                <th>Closing Stock</th>
            </tr>
        </thead>
        <tbody>
            {% for item in report_data %}
            <tr>
                <td>{{ item.product_name }}</td>
                <td>{{ item.sku }}</td>
                <td>{{ item.category }}</td>
                <td>{{ item.supplier }}</td>
                <td class="numeric">{{ item.opening_stock|floatformat:-3 }}</td>
                <td class="numeric">{{ item.purchase_stock|floatformat:-3 }}</td>
                <td class="numeric">{{ item.total_stock|floatformat:-3 }}</td>
                <td class="numeric">{{ item.sale_stock|floatformat:-3 }}</td>
                <td class="numeric">{{ item.wastage_stock|floatformat:-3 }}</td>
                <td class="numeric">{{ item.closing_stock|floatformat:-3 }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="10" class="text-center">No inventory data available for the selected period.</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="table-dark">
                <td colspan="4" class="text-end"><strong>Overall Totals:</strong></td>
                <td class="numeric"><strong>{{ overall_total_opening_stock|floatformat:-3 }}</strong></td>
                <td class="numeric"><strong>{{ overall_total_purchase_stock|floatformat:-3 }}</strong></td>
                <td class="numeric"><strong>{{ overall_total_stock|floatformat:-3 }}</strong></td>
                <td class="numeric"><strong>{{ overall_total_sale_stock|floatformat:-3 }}</strong></td>
                <td class="numeric"><strong>{{ overall_total_wastage_stock|floatformat:-3 }}</strong></td>
                <td class="numeric"><strong>{{ overall_total_closing_stock|floatformat:-3 }}</strong></td>
            </tr>
        </tfoot>
    </table>

    {% elif report_type == 'sales' %}
    <!-- Sales Report -->
    <table>
        <thead>
            <tr>
                <th class="col-date">Date</th>
                <th class="col-product">Product</th>
                <th class="col-qty text-right">Qty</th>
                <th class="col-uom">UOM</th>
                <th class="col-price text-right">Buying</th>
                <th class="col-price text-right">Selling</th>
                <th class="col-price text-right">VAT (%)</th>
                <th class="col-price text-right">AIT (%)</th>
                <th class="col-price text-right">Final</th>
                <th class="col-total text-right">Total</th>
                <th class="col-price text-right">Profit/Loss</th>
                <th class="col-client">Client</th>
                <th class="col-ref">Reference</th>
            </tr>
        </thead>
        <tbody>
            {% if grouped_data %}
                {% for group in grouped_data %}
                <tr>
                    <td colspan="13" class="group-header">{{ group.name }}</td>
                </tr>
                {% for transaction in group.transactions %}
                <tr>
                    <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                    <td>{{ transaction.product.name }}</td>
                    <td class="text-right">{{ transaction.quantity }}</td>
                    <td>{{ transaction.product.unit_of_measure }}</td>
                    <td class="text-right">{{ transaction.buying_price }}</td>
                    <td class="text-right">{{ transaction.selling_price }}</td>
                    <td class="text-right">{% if transaction.apply_taxes %}{{ transaction.vat_rate|default:0 }}{% else %}-{% endif %}</td>
                    <td class="text-right">{% if transaction.apply_taxes %}{{ transaction.ait_rate|default:0 }}{% else %}-{% endif %}</td>
                    <td class="text-right">{% if transaction.apply_taxes and transaction.final_price %}{{ transaction.final_price }}{% else %}{{ transaction.selling_price }}{% endif %}</td>
                    <td class="text-right">{{ transaction.total_price }}</td>
                    <td class="text-right">{{ transaction.profit_loss }}</td>
                    <td>{% if transaction.client %}{{ transaction.client.name }}{% else %}-{% endif %}</td>
                    <td>{{ transaction.reference_number|default:"-" }}</td>
                </tr>
                {% endfor %}
                <tr class="subtotal-row">
                    <td colspan="9" class="text-right">Subtotal:</td>
                    <td class="text-right">{{ group.subtotal|floatformat:2 }}</td>
                    <td colspan="3"></td>
                </tr>
                {% endfor %}
            {% else %}
                {% for transaction in sales %}
                <tr>
                    <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                    <td>{{ transaction.product.name }}</td>
                    <td class="text-right">{{ transaction.quantity }}</td>
                    <td>{{ transaction.product.unit_of_measure }}</td>
                    <td class="text-right">{{ transaction.buying_price }}</td>
                    <td class="text-right">{{ transaction.selling_price }}</td>
                    <td class="text-right">{% if transaction.apply_taxes %}{{ transaction.vat_rate|default:0 }}{% else %}-{% endif %}</td>
                    <td class="text-right">{% if transaction.apply_taxes %}{{ transaction.ait_rate|default:0 }}{% else %}-{% endif %}</td>
                    <td class="text-right">{% if transaction.apply_taxes and transaction.final_price %}{{ transaction.final_price }}{% else %}{{ transaction.selling_price }}{% endif %}</td>
                    <td class="text-right">{{ transaction.total_price }}</td>
                    <td class="text-right">{{ transaction.profit_loss }}</td>
                    <td>{% if transaction.client %}{{ transaction.client.name }}{% else %}-{% endif %}</td>
                    <td>{{ transaction.reference_number|default:"-" }}</td>
                </tr>
                {% endfor %}
            {% endif %}
            <tfoot>
                <tr class="total-row">
                    <td colspan="2" class="text-right"><strong>Total Quantity Sold:</strong></td>
                    <td class="text-right"><strong>{{ total_quantity_sold }}</strong></td>
                    <td colspan="6" class="text-right"><strong>Total Sales:</strong></td>
                    <td class="text-right"><strong>{{ total_sales|floatformat:2 }}</strong></td>
                    <td colspan="3"></td>
                </tr>
            </tfoot>
        </tbody>
    </table>

    {% elif report_type == 'purchase' %}
    <!-- Purchase Report -->
    <table>
        <thead>
            <tr>
                <th class="col-date">Date</th>
                <th class="col-product">Product</th>
                <th class="col-qty text-right">Qty</th>
                <th class="col-uom">UOM</th>
                <th class="col-price text-right">Buying Price</th>
                <th class="col-price text-right">VAT (%)</th>
                <th class="col-price text-right">AIT (%)</th>
                <th class="col-price text-right">Final Price</th>
                <th class="col-total text-right">Total Price</th>
                <th class="col-client">Supplier</th>
                <th class="col-ref">Reference</th>
            </tr>
        </thead>
        <tbody>
            {% if grouped_data %}
                {% for group in grouped_data %}
                <tr>
                    <td colspan="11" class="group-header">{{ group.name }}</td>
                </tr>
                {% for transaction in group.transactions %}
                <tr>
                    <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                    <td>{{ transaction.product.name }}</td>
                    <td class="text-right">{{ transaction.quantity }}</td>
                    <td>{{ transaction.product.unit_of_measure }}</td>
                    <td class="text-right">{{ transaction.buying_price }}</td>
                    <td class="text-right">
                        {% if not transaction.apply_taxes %}
                        -
                        {% else %}
                        {{ transaction.vat_rate|default:0 }}
                        {% endif %}
                    </td>
                    <td class="text-right">
                        {% if not transaction.apply_taxes %}
                        -
                        {% else %}
                        {{ transaction.ait_rate|default:0 }}
                        {% endif %}
                    </td>
                    <td class="text-right">{% if transaction.apply_taxes and transaction.final_price %}{{ transaction.final_price }}{% else %}{{ transaction.buying_price }}{% endif %}</td>
                    <td class="text-right">{{ transaction.total_price }}</td>
                    <td>{% if transaction.product.supplier %}{{ transaction.product.supplier.name }}{% else %}-{% endif %}</td>
                    <td>{{ transaction.reference_number|default:"-" }}</td>
                </tr>
                {% endfor %}
                <tr class="subtotal-row">
                    <td colspan="8" class="text-right">Subtotal:</td>
                    <td class="text-right">{{ group.subtotal|floatformat:2 }}</td>
                    <td colspan="2"></td>
                </tr>
                {% endfor %}
            {% else %}
                {% for transaction in purchases %}
                <tr>
                    <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                    <td>{{ transaction.product.name }}</td>
                    <td class="text-right">{{ transaction.quantity }}</td>
                    <td>{{ transaction.product.unit_of_measure }}</td>
                    <td class="text-right">{{ transaction.buying_price }}</td>
                    <td class="text-right">
                        {% if not transaction.apply_taxes %}
                        -
                        {% else %}
                        {{ transaction.vat_rate|default:0 }}
                        {% endif %}
                    </td>
                    <td class="text-right">
                        {% if not transaction.apply_taxes %}
                        -
                        {% else %}
                        {{ transaction.ait_rate|default:0 }}
                        {% endif %}
                    </td>
                    <td class="text-right">{% if transaction.apply_taxes and transaction.final_price %}{{ transaction.final_price }}{% else %}{{ transaction.buying_price }}{% endif %}</td>
                    <td class="text-right">{{ transaction.total_price }}</td>
                    <td>{% if transaction.product.supplier %}{{ transaction.product.supplier.name }}{% else %}-{% endif %}</td>
                    <td>{{ transaction.reference_number|default:"-" }}</td>
                </tr>
                {% endfor %}
            {% endif %}
            <tfoot>
                <tr class="total-row">
                    <td colspan="2" class="text-right"><strong>Total Quantity Purchased:</strong></td>
                    <td class="text-right"><strong>{{ total_quantity_purchased }}</strong></td>
                    <td colspan="5" class="text-right"><strong>Total Purchases:</strong></td>
                    <td class="text-right"><strong>{{ total_purchases|floatformat:2 }}</strong></td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </tbody>
    </table>

    {% elif report_type == 'wastage' %}
    <!-- Wastage Report -->
    <table>
        <thead>
            <tr>
                <th class="col-date">Date</th>
                <th class="col-product">Product</th>
                <th>Type</th>
                <th class="col-qty text-right">Qty</th>
                <th class="col-price text-right">Buying</th>
                <th class="col-price text-right">Unit Price</th>
                <th class="col-price text-right">Wastage</th>
                <th class="col-price text-right">Profit/Loss</th>
                <th class="col-total text-right">Total</th>
                <th class="col-notes">Notes</th>
            </tr>
        </thead>
        <tbody>
            {% if grouped_data %}
                {% for group in grouped_data %}
                <tr>
                    <td colspan="10" class="group-header">{{ group.name }}</td>
                </tr>
                {% for transaction in group.transactions %}
                <tr>
                    <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                    <td>{{ transaction.product.name }}</td>
                    <td>
                        {% if transaction.transaction_type == 'wastage' %}
                        Wastage
                        {% elif transaction.transaction_type == 'in' %}
                        Purchase
                        {% elif transaction.transaction_type == 'out' %}
                        Sale
                        {% else %}
                        {{ transaction.transaction_type }}
                        {% endif %}
                    </td>
                    <td class="text-right">{{ transaction.quantity }}</td>
                    <td class="text-right">{{ transaction.buying_price }}</td>
                    <td class="text-right">{{ transaction.unit_price }}</td>
                    <td class="text-right">{{ transaction.wastage_amount }}</td>
                    <td class="text-right">
                        {% if transaction.profit_loss > 0 %}
                        {{ transaction.profit_loss }}
                        {% elif transaction.profit_loss < 0 %}
                        {{ transaction.profit_loss|floatformat:2|cut:"-" }}
                        {% else %}
                        {{ transaction.profit_loss }}
                        {% endif %}
                    </td>
                    <td class="text-right">{{ transaction.total_price }}</td>
                    <td>{{ transaction.notes|truncatechars:30|default:"-" }}</td>
                </tr>
                {% endfor %}
                <tr class="subtotal-row">
                    <td colspan="8" class="text-right">Subtotal:</td>
                    <td class="text-right">{{ group.subtotal|floatformat:2 }}</td>
                    <td></td>
                </tr>
                {% endfor %}
            {% else %}
                {% for transaction in wastage %}
                <tr>
                    <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                    <td>{{ transaction.product.name }}</td>
                    <td>
                        {% if transaction.transaction_type == 'wastage' %}
                        Wastage
                        {% elif transaction.transaction_type == 'in' %}
                        Purchase
                        {% elif transaction.transaction_type == 'out' %}
                        Sale
                        {% else %}
                        {{ transaction.transaction_type }}
                        {% endif %}
                    </td>
                    <td class="text-right">{{ transaction.quantity }}</td>
                    <td class="text-right">{{ transaction.buying_price }}</td>
                    <td class="text-right">{{ transaction.unit_price }}</td>
                    <td class="text-right">{{ transaction.wastage_amount }}</td>
                    <td class="text-right">
                        {% if transaction.profit_loss > 0 %}
                        {{ transaction.profit_loss }}
                        {% elif transaction.profit_loss < 0 %}
                        {{ transaction.profit_loss|floatformat:2|cut:"-" }}
                        {% else %}
                        {{ transaction.profit_loss }}
                        {% endif %}
                    </td>
                    <td class="text-right">{{ transaction.total_price }}</td>
                    <td>{{ transaction.notes|truncatechars:30|default:"-" }}</td>
                </tr>
                {% endfor %}
            {% endif %}
            <tr class="total-row">
                <td colspan="8" class="text-right">Total Wastage Value:</td>
                <td class="text-right">{{ total_wastage|floatformat:2 }}</td>
                <td></td>
            </tr>
            <tr>
                <td colspan="10" class="small-text note-text">
                    * The total wastage value includes product costs (quantity Ã— buying price) and any additional wastage costs.
                </td>
            </tr>
        </tbody>
    </table>
    
    {% elif report_type == 'payment' %}
    <!-- Payment Report -->
    <table>
        <thead>
            <tr>
                <th class="col-date">Date</th>
                <th class="col-product">Product</th>
                <th>Transaction Type</th>
                <th class="col-qty text-right">Qty</th>
                <th class="col-total text-right">Total Price</th>
                <th>Payment Status</th>
                <th class="col-price text-right">Amount Paid</th>
                <th class="col-price text-right">Amount Due</th>
                <th class="col-date">Due Date</th>
                <th>Client/Supplier</th>
                <th class="col-ref">Reference</th>
            </tr>
        </thead>
        <tbody>
            {% if grouped_data %}
                {% for group in grouped_data %}
                <tr>
                    <td colspan="11" class="group-header">{{ group.name }}</td>
                </tr>
                {% for transaction in group.transactions %}
                <tr>
                    <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                    <td>{{ transaction.product.name }}</td>
                    <td>
                        {% if transaction.transaction_type == 'in' %}
                        Stock In
                        {% elif transaction.transaction_type == 'out' %}
                        Stock Out
                        {% elif transaction.transaction_type == 'return' %}
                        Return
                        {% else %}
                        {{ transaction.get_transaction_type_display }}
                        {% endif %}
                    </td>
                    <td class="text-right">{{ transaction.quantity }}</td>
                    <td class="text-right">{{ transaction.total_price }}</td>
                    <td>
                        {% if transaction.payment_status == 'paid' %}
                        Paid
                        {% elif transaction.payment_status == 'due' %}
                        Due
                        {% elif transaction.payment_status == 'partial' %}
                        Partially Paid
                        {% elif transaction.payment_status == 'credit' %}
                        Credit
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                    <td class="text-right">{{ transaction.amount_paid }}</td>
                    <td class="text-right">{{ transaction.amount_due }}</td>
                    <td>{% if transaction.payment_due_date %}{{ transaction.payment_due_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                    <td>
                        {% if transaction.transaction_type == 'out' or transaction.transaction_type == 'return' %}
                            {% if transaction.client %}{{ transaction.client.name }}{% else %}-{% endif %}
                        {% elif transaction.transaction_type == 'in' %}
                            {% if transaction.supplier %}{{ transaction.supplier.name }}{% else %}-{% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ transaction.reference_number|default:"-" }}</td>
                </tr>
                {% endfor %}
                <tr class="subtotal-row">
                    <td colspan="6" class="text-right">Subtotal:</td>
                    <td class="text-right">{{ group.total_paid|floatformat:2 }}</td>
                    <td class="text-right">{{ group.total_due|floatformat:2 }}</td>
                    <td colspan="3"></td>
                </tr>
                {% endfor %}
            {% else %}
                {% for transaction in payment_transactions %}
                <tr>
                    <td>{{ transaction.transaction_date|date:"Y-m-d" }}</td>
                    <td>{{ transaction.product.name }}</td>
                    <td>
                        {% if transaction.transaction_type == 'in' %}
                        Stock In
                        {% elif transaction.transaction_type == 'out' %}
                        Stock Out
                        {% elif transaction.transaction_type == 'return' %}
                        Return
                        {% else %}
                        {{ transaction.get_transaction_type_display }}
                        {% endif %}
                    </td>
                    <td class="text-right">{{ transaction.quantity }}</td>
                    <td class="text-right">{{ transaction.total_price }}</td>
                    <td>
                        {% if transaction.payment_status == 'paid' %}
                        Paid
                        {% elif transaction.payment_status == 'due' %}
                        Due
                        {% elif transaction.payment_status == 'partial' %}
                        Partially Paid
                        {% elif transaction.payment_status == 'credit' %}
                        Credit
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                    <td class="text-right">{{ transaction.amount_paid }}</td>
                    <td class="text-right">{{ transaction.amount_due }}</td>
                    <td>{% if transaction.payment_due_date %}{{ transaction.payment_due_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                    <td>
                        {% if transaction.transaction_type == 'out' or transaction.transaction_type == 'return' %}
                            {% if transaction.client %}{{ transaction.client.name }}{% else %}-{% endif %}
                        {% elif transaction.transaction_type == 'in' %}
                            {% if transaction.supplier %}{{ transaction.supplier.name }}{% else %}-{% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ transaction.reference_number|default:"-" }}</td>
                </tr>
                {% endfor %}
            {% endif %}
            <tr class="total-row">
                <td colspan="6" class="text-right">Total:</td>
                <td class="text-right">{{ total_paid|floatformat:2 }}</td>
                <td class="text-right">{{ total_due|floatformat:2 }}</td>
                <td colspan="3"></td>
            </tr>
        </tbody>
    </table>
    
    {% if payment_records %}
    <h3>Payment Transactions</h3>
    <table>
        <thead>
            <tr>
                <th class="col-date">Date</th>
                <th class="col-product">Product</th>
                <th class="col-price text-right">Amount</th>
                <th>Payment Method</th>
                <th class="col-ref">Reference</th>
                <th>Created By</th>
                <th class="col-notes">Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in payment_records %}
            <tr>
                <td>{{ payment.payment_date|date:"Y-m-d" }}</td>
                <td>{{ payment.transaction.product.name }}</td>
                <td class="text-right">{{ payment.amount }}</td>
                <td>{{ payment.get_payment_method_display }}</td>
                <td>{{ payment.reference|default:"-" }}</td>
                <td>{{ payment.created_by.username }}</td>
                <td>{{ payment.notes|truncatechars:30|default:"-" }}</td>
            </tr>
            {% endfor %}
            <tr class="total-row">
                <td colspan="2" class="text-right">Total Payments:</td>
                <td class="text-right">{{ total_payments|floatformat:2 }}</td>
                <td colspan="4"></td>
            </tr>
        </tbody>
    </table>
    {% endif %}
    {% endif %}

    <div class="terms">
        <div class="terms-title">Notes & Terms</div>
        {% if terms_conditions %}
            {{ terms_conditions|linebreaks }}
        {% else %}
        <ol>
            <li>This report is generated from the QBITX Inventory Management System.</li>
            <li>All values are displayed in the default currency.</li>
            <li>For any questions regarding this report, please contact the system administrator.</li>
        </ol>
        {% endif %}
    </div>

    <div class="footer">
        <p>QBITX Inventory Management System &copy; {% now "Y" %}</p>
    </div>
</body>
</html> 